package types

import (
	"bytes"
	"encoding/hex"
	"github.com/ethereum/go-ethereum/accounts/abi"
	"github.com/ethereum/go-ethereum/crypto"
	"strings"
	"testing"

	"github.com/stretchr/testify/require"
)

func TestABIEncodedRebalanceBytes(t *testing.T) {

	rebalanceBytes := Cellar{
		Id: "0x0000000000",
		TickRanges: []*TickRange{
			{-189780, -192480, 160},
			{-192480, -197880, 680},
			{-197880, -200640, 160},
		},
	}.ABIEncodedRebalanceBytes()
	rebalanceHash := crypto.Keccak256Hash(rebalanceBytes).Bytes()

	// hash from python brownie code cc @stevenj
	testHash, err := hex.DecodeString("0xd0f79d9bfeec64dbc27ccd281a20931cfadc07d87875c3289f55383e59f3ebbc"[2:])
	require.NoError(t, err)
	if !bytes.Equal(testHash, rebalanceHash) {
		t.Errorf("gold hash is not equal to generated hash:\n gold hash: %x\n test hash: %x", testHash, rebalanceHash)
	}
}

func TestABIEncodedCellarTickInfoBytes(t *testing.T) {
	tickInfoHash := ABIEncodedCellarTickInfoBytes(0)
	t.Logf("hash: %b", tickInfoHash)
}

func TestABIDecodeRebalanceCall(t *testing.T) {
	hexStr := "0x135D4F2400000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000C80000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000000A0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000012C00000000000000000000000000000000000000000000000000000000000000C8000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000190000000000000000000000000000000000000000000000000000000000000012C000000000000000000000000000000000000000000000000000000000000001E000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001F400000000000000000000000000000000000000000000000000000000000001900000000000000000000000000000000000000000000000000000000000000028"
	abij, err := abiJSON()
	require.NoError(t, err)

	// decode txInput method signature
	decodedSig, err := hex.DecodeString(hexStr[2:10])
	require.NoError(t, err)

	// recover Method from signature and ABI
	method, err := abij.MethodById(decodedSig)
	require.NoError(t, err)

	// decode txInput Payload
	decodedData, err := hex.DecodeString(hexStr[10:])
	require.NoError(t, err)

	data, err := method.Inputs.Unpack(decodedData)
	require.NoError(t, err)
	t.Logf("data: %v", data)
}

func TestABIDecodeLogicCall(t *testing.T) {
	hexStr := "0x0C246C8200000000000000000000000000000000000000000000000000000000000000E000000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000002C000000000000000000000000000000000000000000000000000000000000003600000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000400000000000000000000000014FDAC734DE10065093C4ED4A83C41638378005A0000000000000000000000007BE2A04DF4B9C3227928147461E19158EB2B11D1000000000000000000000000B8C6886FDDA38ADAA0F416722DD5554886C43055000000000000000000000000D312F0F1B39D54DB2829537595FC1167B14D4B340000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000003FFFFFFF000000000000000000000000000000000000000000000000000000003FFFFFFF000000000000000000000000000000000000000000000000000000003FFFFFFF000000000000000000000000000000000000000000000000000000003FFFFFFF0000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001C000000000000000000000000000000000000000000000000000000000000001C000000000000000000000000000000000000000000000000000000000000001B000000000000000000000000000000000000000000000000000000000000001C000000000000000000000000000000000000000000000000000000000000000423975687F12073E970005A98E4530EA838CF782C30A6B08BE0E4EFF17F3A95BE638B10DEB6ADA251AB7D19211196EA3F5F2D449B439E39FAF7C7AD321534E208E07FC044CEC1095564D1AAD9D64CD494E06FB90721BC6012E4E03A21AC5BDE6169BF39377E6C61832443A164EB6962A28C23C84676D0A4C0B37123BBA70D67920000000000000000000000000000000000000000000000000000000000000004227AD83A024693DCC73DAC6CC465508991A211622D4F5DBB0349C24A045C3BCE5DDDEF98F0F534724744DD8F2FD9B6F99476F3AA08F6F3374A8F5904D1B9A09814882F26CD006351F83D9D99114C5FFB56E3DFB62F7FA4F7070CB19751BBA29571B62D3F0D577FA4F33FAB04E970BCD2A7C7F3AC1A383BE41B99ACF46DC8FAE40000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000180000000000000000000000000FBB0BCFED0C82043A7D5387C35AD8450B44A4CDE00000000000000000000000000000000000000000000000000000000000001A00000000000000000000000000000000000000000000000000000000002932E008B8807D47CE8AD4380630888A9DFEB1A7F85BF4D55615100D53F43741176C214000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000244135D4F2400000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000C80000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000000A0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000012C00000000000000000000000000000000000000000000000000000000000000C8000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000190000000000000000000000000000000000000000000000000000000000000012C000000000000000000000000000000000000000000000000000000000000001E000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001F40000000000000000000000000000000000000000000000000000000000000190000000000000000000000000000000000000000000000000000000000000002800000000000000000000000000000000000000000000000000000000"
	abij, err := abi.JSON(strings.NewReader("submitLogicCall(address[],uint256[],uint256,uint8[],bytes32[],bytes32[],(uint256[],address[],uint256[],address[],address,bytes,uint256,bytes32,uint256))"))
	require.NoError(t, err)

	// decode txInput method signature
	decodedSig, err := hex.DecodeString(hexStr[2:10])
	require.NoError(t, err)

	// recover Method from signature and ABI
	method, err := abij.MethodById(decodedSig)
	require.NoError(t, err)

	// decode txInput Payload
	decodedData, err := hex.DecodeString(hexStr[10:])
	require.NoError(t, err)

	data, err := method.Inputs.Unpack(decodedData)
	require.NoError(t, err)
	t.Logf("data: %v", data)
}